{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://github.com/fyrsmithlabs/contextd/schemas/mcp-tools.schema.json",
  "title": "contextd MCP Tools Schema",
  "description": "JSON Schema for all contextd MCP tool inputs/outputs and skill file format. Use @contextd-mcp-tools.schema.json for lazy loading reference.",
  "version": "0.1.0",

  "$defs": {
    "checkpoint_save_input": {
      "type": "object",
      "description": "Input for checkpoint_save tool",
      "properties": {
        "session_id": { "type": "string", "description": "Session identifier" },
        "tenant_id": { "type": "string", "description": "Tenant identifier" },
        "project_path": { "type": "string", "description": "Project path" },
        "name": { "type": "string", "description": "Checkpoint name" },
        "description": { "type": "string", "description": "Human-readable description" },
        "summary": { "type": "string", "description": "Brief summary for quick reference" },
        "context": { "type": "string", "description": "Contextual information" },
        "full_state": { "type": "string", "description": "Complete session state" },
        "token_count": { "type": "integer", "description": "Token count estimate" },
        "threshold": { "type": "number", "description": "Context threshold that triggered checkpoint (0-1)" },
        "auto_created": { "type": "boolean", "description": "True if auto-created by system" },
        "metadata": { "type": "object", "additionalProperties": { "type": "string" }, "description": "Additional metadata" }
      },
      "required": ["session_id", "tenant_id", "project_path", "name", "description", "summary", "context", "full_state", "token_count", "threshold", "auto_created"]
    },

    "checkpoint_save_output": {
      "type": "object",
      "description": "Output from checkpoint_save tool",
      "properties": {
        "id": { "type": "string", "description": "Checkpoint ID" },
        "session_id": { "type": "string", "description": "Session ID" },
        "summary": { "type": "string", "description": "Checkpoint summary" },
        "token_count": { "type": "integer", "description": "Token count" },
        "auto_created": { "type": "boolean", "description": "Auto-created flag" }
      },
      "required": ["id", "session_id", "summary", "token_count", "auto_created"]
    },

    "checkpoint_list_input": {
      "type": "object",
      "description": "Input for checkpoint_list tool",
      "properties": {
        "tenant_id": { "type": "string", "description": "Tenant identifier" },
        "session_id": { "type": "string", "description": "Filter by session ID" },
        "project_path": { "type": "string", "description": "Filter by project path" },
        "limit": { "type": "integer", "default": 20, "description": "Maximum results to return" },
        "auto_only": { "type": "boolean", "description": "Only return auto-created checkpoints" }
      },
      "required": ["tenant_id"]
    },

    "checkpoint_list_output": {
      "type": "object",
      "description": "Output from checkpoint_list tool",
      "properties": {
        "checkpoints": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "id": { "type": "string" },
              "session_id": { "type": "string" },
              "name": { "type": "string" },
              "description": { "type": "string" },
              "summary": { "type": "string" },
              "token_count": { "type": "integer" },
              "threshold": { "type": "number" },
              "auto_created": { "type": "boolean" },
              "created_at": { "type": "string", "format": "date-time" }
            }
          },
          "description": "List of checkpoints"
        },
        "count": { "type": "integer", "description": "Number of checkpoints returned" }
      },
      "required": ["checkpoints", "count"]
    },

    "checkpoint_resume_input": {
      "type": "object",
      "description": "Input for checkpoint_resume tool",
      "properties": {
        "checkpoint_id": { "type": "string", "description": "Checkpoint ID to resume" },
        "tenant_id": { "type": "string", "description": "Tenant identifier" },
        "level": { "type": "string", "enum": ["summary", "context", "full"], "description": "Resume level" }
      },
      "required": ["checkpoint_id", "tenant_id", "level"]
    },

    "checkpoint_resume_output": {
      "type": "object",
      "description": "Output from checkpoint_resume tool",
      "properties": {
        "checkpoint_id": { "type": "string", "description": "Checkpoint ID" },
        "session_id": { "type": "string", "description": "Original session ID" },
        "content": { "type": "string", "description": "Restored content at requested level" },
        "token_count": { "type": "integer", "description": "Token count of restored content" },
        "level": { "type": "string", "description": "Resume level used" }
      },
      "required": ["checkpoint_id", "session_id", "content", "token_count", "level"]
    },

    "memory_search_input": {
      "type": "object",
      "description": "Input for memory_search tool",
      "properties": {
        "project_id": { "type": "string", "description": "Project identifier" },
        "query": { "type": "string", "description": "Search query for relevant memories" },
        "limit": { "type": "integer", "default": 5, "description": "Maximum results" }
      },
      "required": ["project_id", "query"]
    },

    "memory_search_output": {
      "type": "object",
      "description": "Output from memory_search tool",
      "properties": {
        "memories": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "id": { "type": "string" },
              "title": { "type": "string" },
              "content": { "type": "string" },
              "outcome": { "type": "string", "enum": ["success", "failure"] },
              "confidence": { "type": "number", "minimum": 0, "maximum": 1 },
              "tags": { "type": "array", "items": { "type": "string" } }
            }
          },
          "description": "Matching memories"
        },
        "count": { "type": "integer", "description": "Number of results" }
      },
      "required": ["memories", "count"]
    },

    "memory_record_input": {
      "type": "object",
      "description": "Input for memory_record tool",
      "properties": {
        "project_id": { "type": "string", "description": "Project identifier" },
        "title": { "type": "string", "description": "Brief title for the memory" },
        "content": { "type": "string", "description": "The strategy or learning to remember" },
        "outcome": { "type": "string", "enum": ["success", "failure"], "description": "Outcome type" },
        "tags": { "type": "array", "items": { "type": "string" }, "description": "Tags for categorization" }
      },
      "required": ["project_id", "title", "content", "outcome"]
    },

    "memory_record_output": {
      "type": "object",
      "description": "Output from memory_record tool",
      "properties": {
        "id": { "type": "string", "description": "Memory ID" },
        "title": { "type": "string", "description": "Memory title" },
        "outcome": { "type": "string", "description": "Outcome type" },
        "confidence": { "type": "number", "description": "Initial confidence" }
      },
      "required": ["id", "title", "outcome", "confidence"]
    },

    "memory_feedback_input": {
      "type": "object",
      "description": "Input for memory_feedback tool",
      "properties": {
        "memory_id": { "type": "string", "description": "Memory ID to provide feedback on" },
        "helpful": { "type": "boolean", "description": "Whether the memory was helpful" }
      },
      "required": ["memory_id", "helpful"]
    },

    "memory_feedback_output": {
      "type": "object",
      "description": "Output from memory_feedback tool",
      "properties": {
        "memory_id": { "type": "string", "description": "Memory ID" },
        "new_confidence": { "type": "number", "description": "Updated confidence after feedback" },
        "helpful": { "type": "boolean", "description": "Feedback provided" }
      },
      "required": ["memory_id", "new_confidence", "helpful"]
    },

    "remediation_search_input": {
      "type": "object",
      "description": "Input for remediation_search tool",
      "properties": {
        "query": { "type": "string", "description": "Error message or pattern to search for" },
        "tenant_id": { "type": "string", "description": "Tenant identifier" },
        "scope": { "type": "string", "enum": ["project", "team", "org"], "description": "Search scope" },
        "category": { "type": "string", "enum": ["syntax", "runtime", "logic", "config", "dependency", "network", "auth", "data", "performance", "other"], "description": "Error category filter" },
        "min_confidence": { "type": "number", "minimum": 0, "maximum": 1, "description": "Minimum confidence threshold" },
        "limit": { "type": "integer", "default": 10, "description": "Maximum results" },
        "team_id": { "type": "string", "description": "Team ID for team/project scope" },
        "project_path": { "type": "string", "description": "Project path for project scope" },
        "include_hierarchy": { "type": "boolean", "description": "Search parent scopes (project->team->org)" }
      },
      "required": ["query", "tenant_id"]
    },

    "remediation_search_output": {
      "type": "object",
      "description": "Output from remediation_search tool",
      "properties": {
        "remediations": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "id": { "type": "string" },
              "title": { "type": "string" },
              "problem": { "type": "string" },
              "root_cause": { "type": "string" },
              "solution": { "type": "string" },
              "category": { "type": "string" },
              "confidence": { "type": "number" },
              "score": { "type": "number" },
              "usage_count": { "type": "integer" }
            }
          },
          "description": "Matching remediations with scores"
        },
        "count": { "type": "integer", "description": "Number of results" }
      },
      "required": ["remediations", "count"]
    },

    "remediation_record_input": {
      "type": "object",
      "description": "Input for remediation_record tool",
      "properties": {
        "title": { "type": "string", "description": "Brief title" },
        "problem": { "type": "string", "description": "Problem description" },
        "symptoms": { "type": "array", "items": { "type": "string" }, "description": "Observable symptoms" },
        "root_cause": { "type": "string", "description": "Root cause analysis" },
        "solution": { "type": "string", "description": "How to fix it" },
        "code_diff": { "type": "string", "description": "Code changes (diff format)" },
        "affected_files": { "type": "array", "items": { "type": "string" }, "description": "Files that were changed" },
        "category": { "type": "string", "enum": ["syntax", "runtime", "logic", "config", "dependency", "network", "auth", "data", "performance", "other"], "description": "Error category" },
        "confidence": { "type": "number", "minimum": 0, "maximum": 1, "default": 0.5, "description": "Confidence score" },
        "tags": { "type": "array", "items": { "type": "string" }, "description": "Tags for categorization" },
        "tenant_id": { "type": "string", "description": "Tenant identifier" },
        "scope": { "type": "string", "enum": ["project", "team", "org"], "description": "Scope level" },
        "team_id": { "type": "string", "description": "Team ID (for team/project scope)" },
        "project_path": { "type": "string", "description": "Project path (for project scope)" },
        "session_id": { "type": "string", "description": "Session that created this remediation" }
      },
      "required": ["title", "problem", "root_cause", "solution", "category", "tenant_id", "scope"]
    },

    "remediation_record_output": {
      "type": "object",
      "description": "Output from remediation_record tool",
      "properties": {
        "id": { "type": "string", "description": "Remediation ID" },
        "title": { "type": "string", "description": "Remediation title" },
        "category": { "type": "string", "description": "Error category" },
        "confidence": { "type": "number", "description": "Confidence score" }
      },
      "required": ["id", "title", "category", "confidence"]
    },

    "repository_index_input": {
      "type": "object",
      "description": "Input for repository_index tool",
      "properties": {
        "path": { "type": "string", "description": "Repository path to index" },
        "tenant_id": { "type": "string", "description": "Tenant identifier (defaults to git username)" },
        "branch": { "type": "string", "description": "Git branch to index (auto-detects if empty)" },
        "include_patterns": { "type": "array", "items": { "type": "string" }, "description": "Glob patterns to include (e.g. *.go)" },
        "exclude_patterns": { "type": "array", "items": { "type": "string" }, "description": "Glob patterns to exclude (e.g. vendor/**)" },
        "max_file_size": { "type": "integer", "default": 1048576, "description": "Maximum file size in bytes (default 1MB)" }
      },
      "required": ["path"]
    },

    "repository_index_output": {
      "type": "object",
      "description": "Output from repository_index tool",
      "properties": {
        "path": { "type": "string", "description": "Indexed path" },
        "branch": { "type": "string", "description": "Git branch indexed" },
        "collection_name": { "type": "string", "description": "Vector collection name" },
        "files_indexed": { "type": "integer", "description": "Number of files indexed" },
        "include_patterns": { "type": "array", "items": { "type": "string" }, "description": "Include patterns used" },
        "exclude_patterns": { "type": "array", "items": { "type": "string" }, "description": "Exclude patterns used" },
        "max_file_size": { "type": "integer", "description": "Max file size used" }
      },
      "required": ["path", "branch", "collection_name", "files_indexed", "include_patterns", "exclude_patterns", "max_file_size"]
    },

    "repository_search_input": {
      "type": "object",
      "description": "Input for repository_search tool",
      "properties": {
        "query": { "type": "string", "description": "Semantic search query" },
        "project_path": { "type": "string", "description": "Project path to search within" },
        "tenant_id": { "type": "string", "description": "Tenant identifier (defaults to git username)" },
        "branch": { "type": "string", "description": "Filter by branch (empty = all branches)" },
        "limit": { "type": "integer", "default": 10, "description": "Maximum results (default: 10)" }
      },
      "required": ["query", "project_path"]
    },

    "repository_search_output": {
      "type": "object",
      "description": "Output from repository_search tool",
      "properties": {
        "results": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "file_path": { "type": "string", "description": "File path" },
              "content": { "type": "string", "description": "Matched content" },
              "score": { "type": "number", "description": "Similarity score" },
              "metadata": { "type": "object", "additionalProperties": true, "description": "Additional metadata" }
            }
          },
          "description": "Search results with file paths and content"
        },
        "count": { "type": "integer", "description": "Number of results returned" },
        "query": { "type": "string", "description": "Original search query" },
        "branch": { "type": "string", "description": "Branch filter applied (if any)" }
      },
      "required": ["results", "count", "query"]
    },

    "troubleshoot_diagnose_input": {
      "type": "object",
      "description": "Input for troubleshoot_diagnose tool",
      "properties": {
        "error_message": { "type": "string", "description": "Error message to diagnose" },
        "error_context": { "type": "string", "description": "Additional context (stack trace, logs, etc)" }
      },
      "required": ["error_message"]
    },

    "troubleshoot_diagnose_output": {
      "type": "object",
      "description": "Output from troubleshoot_diagnose tool",
      "properties": {
        "error_message": { "type": "string", "description": "Original error message" },
        "root_cause": { "type": "string", "description": "Likely root cause" },
        "hypotheses": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "description": { "type": "string" },
              "probability": { "type": "number" },
              "evidence": { "type": "array", "items": { "type": "string" } }
            }
          },
          "description": "Diagnostic hypotheses ranked by probability"
        },
        "recommendations": { "type": "array", "items": { "type": "string" }, "description": "Recommended actions" },
        "related_patterns": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "pattern": { "type": "string" },
              "description": { "type": "string" },
              "fix": { "type": "string" }
            }
          },
          "description": "Similar known error patterns"
        },
        "confidence": { "type": "number", "minimum": 0, "maximum": 1, "description": "Overall diagnostic confidence" }
      },
      "required": ["error_message", "root_cause", "hypotheses", "recommendations", "related_patterns", "confidence"]
    },

    "skill_frontmatter": {
      "type": "object",
      "description": "SKILL.md frontmatter format",
      "properties": {
        "name": {
          "type": "string",
          "pattern": "^[a-z0-9-]+$",
          "maxLength": 64,
          "description": "Skill name (letters, numbers, hyphens only)"
        },
        "description": {
          "type": "string",
          "maxLength": 960,
          "description": "When to use this skill (starts with 'Use when...')"
        }
      },
      "required": ["name", "description"]
    },

    "skill_file": {
      "type": "object",
      "description": "Complete SKILL.md structure",
      "properties": {
        "frontmatter": { "$ref": "#/$defs/skill_frontmatter" },
        "content": {
          "type": "object",
          "properties": {
            "overview": { "type": "string", "description": "Core principle in 1-2 sentences" },
            "when_to_use": { "type": "array", "items": { "type": "string" }, "description": "Triggers and symptoms" },
            "when_not_to_use": { "type": "array", "items": { "type": "string" }, "description": "Anti-patterns" },
            "process": { "type": "array", "items": { "type": "string" }, "description": "Step-by-step workflow" },
            "common_mistakes": { "type": "array", "items": { "type": "string" }, "description": "What goes wrong + fixes" }
          }
        }
      },
      "required": ["frontmatter"]
    }
  },

  "type": "object",
  "properties": {
    "tools": {
      "type": "object",
      "description": "MCP tool schemas by tool name",
      "properties": {
        "checkpoint_save": {
          "type": "object",
          "properties": {
            "input": { "$ref": "#/$defs/checkpoint_save_input" },
            "output": { "$ref": "#/$defs/checkpoint_save_output" }
          }
        },
        "checkpoint_list": {
          "type": "object",
          "properties": {
            "input": { "$ref": "#/$defs/checkpoint_list_input" },
            "output": { "$ref": "#/$defs/checkpoint_list_output" }
          }
        },
        "checkpoint_resume": {
          "type": "object",
          "properties": {
            "input": { "$ref": "#/$defs/checkpoint_resume_input" },
            "output": { "$ref": "#/$defs/checkpoint_resume_output" }
          }
        },
        "memory_search": {
          "type": "object",
          "properties": {
            "input": { "$ref": "#/$defs/memory_search_input" },
            "output": { "$ref": "#/$defs/memory_search_output" }
          }
        },
        "memory_record": {
          "type": "object",
          "properties": {
            "input": { "$ref": "#/$defs/memory_record_input" },
            "output": { "$ref": "#/$defs/memory_record_output" }
          }
        },
        "memory_feedback": {
          "type": "object",
          "properties": {
            "input": { "$ref": "#/$defs/memory_feedback_input" },
            "output": { "$ref": "#/$defs/memory_feedback_output" }
          }
        },
        "remediation_search": {
          "type": "object",
          "properties": {
            "input": { "$ref": "#/$defs/remediation_search_input" },
            "output": { "$ref": "#/$defs/remediation_search_output" }
          }
        },
        "remediation_record": {
          "type": "object",
          "properties": {
            "input": { "$ref": "#/$defs/remediation_record_input" },
            "output": { "$ref": "#/$defs/remediation_record_output" }
          }
        },
        "repository_index": {
          "type": "object",
          "properties": {
            "input": { "$ref": "#/$defs/repository_index_input" },
            "output": { "$ref": "#/$defs/repository_index_output" }
          }
        },
        "repository_search": {
          "type": "object",
          "properties": {
            "input": { "$ref": "#/$defs/repository_search_input" },
            "output": { "$ref": "#/$defs/repository_search_output" }
          }
        },
        "troubleshoot_diagnose": {
          "type": "object",
          "properties": {
            "input": { "$ref": "#/$defs/troubleshoot_diagnose_input" },
            "output": { "$ref": "#/$defs/troubleshoot_diagnose_output" }
          }
        }
      }
    },
    "skill_format": { "$ref": "#/$defs/skill_file" }
  }
}
